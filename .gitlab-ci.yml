default:
  image: $CI_REGISTRY_IMAGE

variables:
  POSTGRES_DB: $POSTGRES_DB
  POSTGRES_USER: $POSTGRES_USER
  POSTGRES_PASSWORD: $POSTGRES_PASSWORD
  POSTGRES_HOST_AUTH_METHOD: trust

stages:
  - build
  - setup-back
  - test
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cache/pypoetry
    - .venv/


before_script:
  - poetry install --no-root


build-job:
  stage: build
  inherit:
    default: false
  image: docker
  services:
    - docker:dind
  before_script:
    - mkdir -p $HOME/.docker
    - echo $DOCKER_AUTH_CONFIG > $HOME/.docker/config.json
  script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER  $CI_REGISTRY --password-stdin
    - docker build -t $CI_REGISTRY_IMAGE .
    - docker push $CI_REGISTRY_IMAGE


setup-back-job:
  stage: setup-back
  needs:
    - ["build-job"]
  script:
    - poetry config virtualenvs.create true
    - poetry config virtualenvs.in-project true
    - poetry install --no-root
    - ls -la .venv


pycs:
  stage: test
  needs:
    - ["setup-back-job"]
  script:
    - poetry run autopep8 --in-place --aggressive --recursive .
    - poetry run flake8 app/
    - poetry run black app/
    - poetry run isort app/


pystan:
  stage: test
  needs:
    - ["setup-back-job"]
  script:
    - poetry run mypy app/
    - poetry run pylint app/
    - poetry run bandit -r app/


pytest:
  stage: test
  services:
    - name: postgres:latest
      alias: postgres
  needs:
    - ["setup-back-job"]
  before_script:
    - apt-get update && apt-get install -y postgresql postgresql-client libpq-dev
    - until pg_isready -h postgres -p 5432 -U "$POSTGRES_USER"; do echo "Waiting for database..."; sleep 2; done
    - psql -h "postgres" -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "SELECT 'OK' AS status;"

  script:
    - poetry run pytest --junitxml=results.xml  --verbose --disable-warnings


deploy:
  stage: deploy
  script:
    - docker pull $CI_REGISTRY_IMAGE:latest
    - docker run -d -p 9898:9898 --env-file .env $CI_REGISTRY_IMAGE:latest
